// ==UserScript==
// @name        SO Plagiarism Case Manager
// @description Help facilitate and track collaborative plagiarism cleanup efforts
// @homepage    https://github.com/HenryEcker/SOCaseManagerUserScript
// @author      Henry Ecker (https://github.com/HenryEcker)
// @version     0.5.6
// @downloadURL https://github.com/HenryEcker/SOCaseManagerUserScript/raw/master/dist/SOCaseManager.min.user.js
// @updateURL   https://github.com/HenryEcker/SOCaseManagerUserScript/raw/master/dist/SOCaseManager.min.user.js
// @match       *://stackoverflow.com/questions/*
// @match       *://stackoverflow.com/users
// @match       *://stackoverflow.com/users?*
// @match       *://stackoverflow.com/users/*
// @exclude     *://stackoverflow.com/questions/ask*
// @exclude     *://stackoverflow.com/users/apps/*
// @exclude     *://stackoverflow.com/users/delete/*
// @exclude     *://stackoverflow.com/users/edit/*
// @exclude     *://stackoverflow.com/users/email/*
// @exclude     *://stackoverflow.com/users/hidecommunities/*
// @exclude     *://stackoverflow.com/users/message/*
// @exclude     *://stackoverflow.com/users/my-collectives/*
// @exclude     *://stackoverflow.com/users/mylogins/*
// @exclude     *://stackoverflow.com/users/preferences/*
// @exclude     *://stackoverflow.com/users/saves/*
// @exclude     *://stackoverflow.com/users/tag-notifications/*
// @exclude     *://stackoverflow.com/users/teams/*
// @grant       GM_deleteValue
// @grant       GM_getValue
// @grant       GM_setValue
// ==/UserScript==
/* globals $, StackExchange */

!function(){"use strict";const e="access_token",t="se_api_token",a="cm_role_id",s=JSON.stringify({flagDetailText:"",commentText:"",flag:!1,comment:!1,log:!0}),n="cm_nuke_post_config";function o(){return r("/auth/cm/jwt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({se_api_token:GM_getValue(t)})},!1).then((e=>e.json())).then((t=>{GM_setValue(e,t.cm_access_token)})).then(i).catch((t=>{GM_deleteValue(e),console.error(t)}))}function i(){return r("/auth/credentials/my-role").then((e=>e.json())).then((e=>{GM_setValue(a,e.role_id)}))}function r(t,a,s=!0){let n=s?{headers:{access_token:GM_getValue(e)}}:{};return void 0!==a&&(n={...a,headers:{...a.headers,...n.headers}}),fetch(`https://4shuk8vsp8.execute-api.us-east-1.amazonaws.com/prod${t}`,n).then((e=>401===e.status?o().then((()=>r(t,a))):e))}function l(e){return e.length<=0?Promise.resolve({}):r(`/summary/posts/${e.join(";")}/actions`).then((e=>e.json())).then((e=>Promise.resolve(e)))}const d="https://stackoverflow.com/oauth?client_id=24380&scope=no_expiry&redirect_uri=https://4shuk8vsp8.execute-api.us-east-1.amazonaws.com/prod/auth/se/oauth";function c(e){return`${e}-input`}function u(e,t){return fetch(e,{method:"POST",body:(a=t,Object.entries(a).reduce(((e,[t,a])=>(e.set(t,a),e)),new FormData))});var a}function p(e){const t=document.getElementById(e);null!==t&&(Stacks.hideModal(t),setTimeout((()=>{t.remove()}),125))}function h(e,t){const a=t.min??0;return void 0===t.max?a<=e:a<=e&&e<=t.max}const g={min:10},m={min:10,max:500},f={min:15,max:600};function b(e){return e instanceof Error?e.message:"string"==typeof e?e:(console.error(e),"Something went wrong!")}function v(e){return"socm-handle-post-form-{postId}".formatUnicorn({postId:e})}function w(e,t,a,s){const n=$(`<button ${t?"disabled":""}  class="ml-auto s-btn s-btn__danger s-btn__outlined" type="button">${e?"Nuke":"Flag"} as plagiarism</button>`);return n.on("click",(()=>{!function(e,t,a){const s=v(t),n=document.getElementById(s);null!==n?Stacks.showModal(n):($("body").append((e?'<aside class="s-modal s-modal__danger" id="{modalId}" tabindex="-1" role="dialog" aria-hidden="true" data-controller="s-modal" data-s-modal-target="modal"><div class="s-modal--dialog" style="min-width:550px; width: max-content; max-width: 65vw;" role="document" data-controller="socm-handle-post-form se-draggable socm-absolute-link-reducer"><h1 class="s-modal--header c-move" data-se-draggable-target="handle">Nuke Plagiarism</h1><div class="s-modal--body" style="margin-bottom: 0;"><div class="d-flex fd-column g8"><div class="d-flex ai-center g8 jc-space-between"><label class="s-label" for="socm-flag-enable-toggle-{postId}">Flag before deletion</label><input class="s-toggle-switch" id="socm-flag-enable-toggle-{postId}" data-socm-handle-post-form-target="flag-enable-toggle" data-socm-handle-post-form-controls-param="flag-info-area" data-action="change->socm-handle-post-form#handleUpdateControlledField" type="checkbox"></div><div class="d-flex fd-column g8" data-socm-handle-post-form-target="flag-info-area"><div class="d-flex ff-column-nowrap gs4 gsy"><div class="flex--item"><label class="d-block s-label" for="socm-flag-original-source-area-{postId}">Link(s) to original content</label></div><div class="d-flex ps-relative"><input type="text" id="socm-flag-original-source-area-{postId}" class="s-input" name="flag source link" data-socm-handle-post-form-target="flag-original-source-area"></div></div><div class="d-flex ff-column-nowrap gs4 gsy" data-controller="se-char-counter" data-se-char-counter-min="10" data-se-char-counter-max="500"><label class="s-label flex--item" for="socm-flag-detail-area-{postId}">Why do you consider this answer to be plagiarized?</label><textarea class="flex--item s-textarea" data-se-char-counter-target="field" data-is-valid-length="false" id="socm-flag-detail-area-{postId}" name="flag detail text" rows="5" data-socm-handle-post-form-target="flag-detail-area" data-action="socm-absolute-link-reducer#handleReduceText"></textarea><div data-se-char-counter-target="output"></div></div></div><div class="my6 bb bc-black-400"></div><div class="d-flex ai-center g8 jc-space-between"><label class="s-label" for="socm-comment-enable-toggle-{postId}">Comment after deletion</label><input class="s-toggle-switch" id="socm-comment-enable-toggle-{postId}" data-socm-handle-post-form-target="comment-enable-toggle" data-socm-handle-post-form-controls-param="comment-info-area" data-action="change->socm-handle-post-form#handleUpdateControlledField" type="checkbox"></div><div class="d-flex fd-column g8" data-socm-handle-post-form-target="comment-info-area"><div class="d-flex ff-column-nowrap gs4 gsy" data-controller="se-char-counter" data-se-char-counter-min="15" data-se-char-counter-max="600"><label class="s-label flex--item" for="socm-comment-area-{postId}">Comment Text</label><textarea class="flex--item s-textarea" data-se-char-counter-target="field" data-is-valid-length="false" id="socm-comment-area-{postId}" name="comment text" rows="5" data-socm-handle-post-form-target="comment-area" data-action="socm-absolute-link-reducer#handleReduceText"></textarea><div data-se-char-counter-target="output"></div></div></div><div class="my6 bb bc-black-400"></div><div class="d-flex ai-center g8 jc-space-between"><label class="s-label" for="socm-log-post-toggle-{postId}">Log post in Case Manager</label><input class="s-toggle-switch" id="socm-log-post-toggle-{postId}" data-socm-handle-post-form-target="log-enable-toggle" type="checkbox"></div></div></div><div class="d-flex gx8 s-modal--footer ai-center"><button class="s-btn flex--item s-btn__filled s-btn__danger" type="button" data-socm-handle-post-form-target="submit-button" data-action="click->socm-handle-post-form#handleNukeSubmitActions" data-socm-handle-post-form-post-id-param="{postId}" data-socm-handle-post-form-post-owner-param="{postOwnerId}">Nuke Post</button><button class="s-btn flex--item s-btn__muted" type="button" data-action="click->socm-handle-post-form#cancelHandleForm" data-socm-handle-post-form-post-id-param="{postId}">Cancel</button><a class="fs-fine ml-auto" href="/users/current?tab=case-manager-settings" target="_blank">Configure default options</a></div><button class="s-modal--close s-btn s-btn__muted" type="button" aria-label="Close" data-action="s-modal#hide"><svg aria-hidden="true" class="svg-icon iconClearSm" width="14" height="14" viewBox="0 0 14 14"><path d="M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41Z"></path></svg></button></div></aside>':'<aside class="s-modal s-modal__danger" id="{modalId}" tabindex="-1" role="dialog" aria-hidden="true" data-controller="s-modal" data-s-modal-target="modal"><div class="s-modal--dialog" style="min-width:550px; width: max-content; max-width: 65vw;" role="document" data-controller="socm-handle-post-form se-draggable socm-absolute-link-reducer"><h1 class="s-modal--header c-move" data-se-draggable-target="handle">Flag Plagiarism</h1><div class="s-modal--body" style="margin-bottom: 0;"><div class="d-flex fd-column g8"><div class="d-flex ff-column-nowrap gs4 gsy"><div class="flex--item"><label class="d-block s-label" for="socm-flag-original-source-area-{postId}">Link(s) to original content</label></div><div class="d-flex ps-relative"><input type="text" id="socm-flag-original-source-area-{postId}" class="s-input" name="flag source link" data-socm-handle-post-form-target="flag-original-source-area"></div></div><div class="d-flex ff-column-nowrap gs4 gsy" data-controller="se-char-counter" data-se-char-counter-min="10" data-se-char-counter-max="500"><label class="s-label flex--item" for="socm-flag-detail-area-{postId}">Why do you consider this answer to be plagiarized?</label><textarea class="flex--item s-textarea" data-se-char-counter-target="field" data-is-valid-length="false" id="socm-flag-detail-area-{postId}" name="flag detail text" rows="5" data-socm-handle-post-form-target="flag-detail-area" data-action="socm-absolute-link-reducer#handleReduceText"></textarea><div data-se-char-counter-target="output"></div></div><div class="my6 bb bc-black-400"></div><div class="d-flex ai-center g8 jc-space-between"><label class="s-label" for="socm-log-post-toggle-{postId}">Log post in Case Manager</label><input class="s-toggle-switch" id="socm-log-post-toggle-{postId}" data-socm-handle-post-form-target="log-enable-toggle" type="checkbox"></div></div></div><div class="d-flex gx8 s-modal--footer ai-center"><button class="s-btn flex--item s-btn__filled s-btn__danger" type="button" data-socm-handle-post-form-target="submit-button" data-action="click->socm-handle-post-form#handleFlagSubmitActions" data-socm-handle-post-form-post-id-param="{postId}" data-socm-handle-post-form-post-owner-param="{postOwnerId}">Flag Post</button><button class="s-btn flex--item s-btn__muted" type="button" data-action="click->socm-handle-post-form#cancelHandleForm" data-socm-handle-post-form-post-id-param="{postId}">Cancel</button></div><button class="s-modal--close s-btn s-btn__muted" type="button" aria-label="Close" data-action="s-modal#hide"><svg aria-hidden="true" class="svg-icon iconClearSm" width="14" height="14" viewBox="0 0 14 14"><path d="M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41Z"></path></svg></button></div></aside>').formatUnicorn({modalId:s,postId:t,postOwnerId:a})),setTimeout((()=>{Stacks.showModal(document.getElementById(s))}),50))}(e,a,s)})),n}async function y(e,t,a){e.preventDefault(),t.prop("disabled",!0).addClass("is-loading");const{postOwner:s,postId:n}=e.params;try{await a(s,n)}catch(o){StackExchange.helpers.showToast(b(o),{type:"danger"}),t.prop("disabled",!1).removeClass("is-loading")}}async function _(e,t,a,s,n,o,i,l,d){let c;if(o&&function(e,t){if(!h(e,g))throw new Error(`Plagiarism flag source must be more than ${g.min} characters.`);if(!h(t,m))throw new Error(`Plagiarism flag explanation text must be between ${m.min} and ${m.max} characters.`)}(a.length,s.length),l&&function(e){if(!h(e,f))throw new Error(`Comment text must be between ${f.min} and ${f.max} characters.`)}(n.length),o){const t=await(p=e,b=a,v=s,function(e,t,a,s,n){const o={fkey:StackExchange.options.user.fkey,otherText:a??"",overrideWarning:!1};return void 0!==n&&(o.customData=JSON.stringify(n)),function(e,t){return u(e,t).then((e=>e.json()))}(`/flags/posts/${t}/add/PlagiarizedContent`,o)}(0,p,v,0,{plagiarizedSource:b}));if(!t.Success)throw new Error(t.Message);i||(c=t.Message)}var p,b,v;if(i){const t=await function(e){return u(`/admin/posts/${e}/delete-as-plagiarism`,{fkey:StackExchange.options.user.fkey})}(e);if(200!==t.status)throw new Error('Something went wrong when deleting "as plagiarism"!')}if(l&&await void function(e,t){u(`/posts/${e}/comments`,{fkey:StackExchange.options.user.fkey,comment:t})}(e,n),d){const a={};-1!==t&&(a.postOwnerId=t);const s=[3];i&&s.push(4),a.feedbackIds=s,await void r(`/handle/post/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}return c}const x="popover-mount-point";function k(e){return`${e}-timeline-indicator-button`}function T(e){return`case-manager-timeline-popover-${e}`}function S(e){return`${e}-post-actions-button`}function P(e){return`case-manager-answer-popover-${e}`}function C(e=18,t=18){return`<svg aria-hidden="true" class="svg-icon iconAlert" width="${e}" height="${e}" viewBox="0 0 ${t} ${t}"><path d="M7.95 2.71c.58-.94 1.52-.94 2.1 0l7.69 12.58c.58.94.15 1.71-.96 1.71H1.22C.1 17-.32 16.23.26 15.29L7.95 2.71ZM8 6v5h2V6H8Zm0 7v2h2v-2H8Z"></path></svg>`}function I(e=18,t=18){return`<svg aria-hidden="true" class="svg-icon iconCheckmark" width="${e}" height="${e}" viewBox="0 0 ${t} ${t}"><path d="M16 4.41 14.59 3 6 11.59 2.41 8 1 9.41l5 5 10-10Z"></path></svg>`}const M=new Intl.DateTimeFormat(void 0,{month:"short",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",timeZone:"UTC",hour12:!1});function D(e){const t=M.formatToParts(new Date(e));return t[5].value=" at ",t.map((e=>e.value)).join("")}function L(e){const t=$(`<button id="${k(e)}" class="flex--item s-btn s-btn__danger ws-nowrap" type="button" disabled>Post Timeline</button>`),a=$(`<div class="s-popover" style="max-width: max-content;" id="${T(e)}" role="menu"><div class="s-popover--arrow"/><div class="${x}"><div class="is-loading">Loading…</div></div></div>`);return $(document.createDocumentFragment()).append(t).append(a)}function j(e){const t=k(e);$(`#${t}`).replaceWith(function(e,t){const a=T(t),s=$(`<button title="Click to view a record of actions taken on this post." id="${e}" class="flex--item s-btn s-btn__danger s-btn__icon ws-nowrap s-btn__dropdown"  role="button" aria-controls="${a}" aria-expanded="false" data-controller="s-popover" data-action="s-popover#toggle" data-s-popover-placement="top-start" data-s-popover-toggle-class="is-selected">${C()}<span class="px8">Post Timeline</span></button>`);return s.on("click",(e=>{e.preventDefault(),"true"!==s.attr("timeline-loaded")&&r(`/timeline/post/${t}`).then((e=>e.json())).then((e=>{const t=$('<div class="case-manager-post-timeline-container"></div>');t.append($("<h3>Case Manager Post Timeline</h3>"));const n=$('<div class="d-grid ws-nowrap" style="grid-template-columns: repeat(3, min-content); grid-gap: var(--su8);"></div>');for(const a of e)n.append($(`<a href="/users/${a.account_id}">${a.display_name}</a><span data-event-type-id="${a.timeline_event_type}">${a.timeline_event_description}</span><span title="${a.event_creation_date}">${D(a.event_creation_date)}</span>`));t.append(n),$(`#${a} > .${x}`).empty().append(t),s.attr("timeline-loaded","true")}))})),s}(t,e))}function E(e,t,a){const s=$(`<button id="${S(e)}" title="Click to record your feedback on this post." class="s-btn s-btn__dropdown" role="button" aria-controls="${P(e)}" aria-expanded="false" data-controller="s-popover" data-action="s-popover#toggle" data-s-popover-placement="top-end" data-s-popover-toggle-class="is-selected">Record Post Feedback</button>`),n=$(`<div class="s-popover" style="width: 275px;" id="${P(e)}" role="menu"><div class="s-popover--arrow"/><div class="${x}"></div></div>`);return s.on("click",(n=>{n.preventDefault(),"true"!==s.attr("options-loaded")&&($(`#${P(e)} > .${x}`).empty().append('<div class="is-loading">Loading…</div>'),r(`/handle/post/${e}`).then((e=>e.json())).then((n=>{F(e,t,a,n),s.attr("options-loaded","true")})))})),$(document.createDocumentFragment()).append(s).append(n)}function F(e,t,a,s){const n=$('<div class="case-manager-post-action-container"><h3>Case Manager Post Feedback Panel</h3></div>'),o=$('<form class="d-grid grid__1 g6" style="grid-auto-rows: 1fr"></form>'),i=`radio-action-${e}`;let l=!1;for(const r of s){const t=$('<div class="grid--item d-flex fd-row jc-space-between ai-center"></div>'),a=O(e,r.feedback_id),s=$(`<div class="flex--item s-check-control"><input class="s-radio" type="radio" name="${i}" value="${r.feedback_description}" data-action-id="${r.feedback_id}" id="${a}"${r.has_given_feedback?" checked":""}/><label class="flex--item s-label fw-normal" for="${a}">${r.feedback_description}</label></div>`);if(t.append(s),r.has_given_feedback){l=!0;const a=$('<button class="s-btn s-btn__danger" type="button">Clear</button>');a.on("click",R(r,e)),t.append(a)}o.append(t)}l&&o.find(`input[name="${i}"]`).prop("disabled",!0),o.append($(`\n<div class="d-flex fd-row jc-start">\n<button class="s-btn s-btn__primary" type="submit"${l?" disabled":""}>Save</button>\n<button class="s-btn" type="reset"${l?" disabled":""}>Reset</button>\n</div>\n`)),o.on("submit",function(e,t,a,s){return n=>{n.preventDefault();const o=e.find('button[type="submit"]');o.prop("disabled",!0);const i=e.find('input[type="radio"]:checked:not(:disabled)');if(0===i.length)return void o.prop("disabled",!1);const l={};-1!==a&&(l.postOwnerId=a);const d=i.map(((e,t)=>{const a=$(t).attr("data-action-id");return void 0===a?void 0:Number(a)})).toArray();s&&d.push(4),l.feedbackIds=d,r(`/handle/post/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}).then((e=>e.json())).then((e=>{j(t),F(t,a,s,e)})).catch((()=>{o.prop("disabled",!1)}))}}(o,e,t,a)),n.append(o),$(`#${P(e)} > .${x}`).empty().append(n)}function O(e,t){return`radio-button-${e}-${t}`}function R(e,t){return a=>{a.preventDefault(),StackExchange.helpers.showConfirmModal({title:"Remove your feedback",bodyHtml:`<span>Are you sure you want to remove your "${e.feedback_description}" feedback from this post?</span>`,buttonLabel:"Remove Feedback"}).then((a=>{a&&r(`/handle/post/${t}/${e.feedback_id}`,{method:"DELETE"}).then((e=>{200===e.status&&($(`#${S(t)}`).attr("options-loaded","false"),$(`#${k(t)}`).attr("timeline-loaded","false"))}))}))}}function A(e){const t=$(e).find("a");if(0===t.length)return-1;const a=t.attr("href");if(void 0===a)return-1;const s=a.match(/\/users\/(\d+)\/.*/);return null===s?-1:Number(s[1])}function N(e,t,a){return`<option value="${t}"${a===t?" selected":""}>${e}</option>`}class U{container;userId;systemUserRoleId;currentPage;pageLoadMap;postSummaryColumnFilter;constructor(e){this.systemUserRoleId=GM_getValue(a),this.userId=e,this.container=$('<div class="d-flex mb48"></div>'),this.currentPage="summary",this.pageLoadMap={summary:{isLoaded:!1},posts:{isLoaded:!1}},this.postSummaryColumnFilter={}}getConfigFromUrl(){const e=new URLSearchParams(window.location.search);e.has("page")&&"summary"!==e.get("page")?"posts"===e.get("page")&&(this.currentPage="posts"):this.currentPage="summary",e.has("table-filter")&&(this.postSummaryColumnFilter=JSON.parse(e.get("table-filter")))}init(){return this.getConfigFromUrl(),window.addEventListener("popstate",(()=>{this.getConfigFromUrl(),this.render()})),this.render(),this.container}buildNavLi(e,t,a){const s=$("<li></li>"),n=this.currentPage===a,o=$(`<a class="s-navigation--item pr48 ps-relative${n?" is-selected":""}" href="${t}">${e}</a>`);return o.on("click",(e=>{e.preventDefault(),this.currentPage=a,n||(window.history.pushState({cmcPageName:a},"",t),this.render())})),s.append(o),s}buildNav(){const e=$('<nav class="flex--item fl-shrink0 mr32" role="navigation"></nav>'),t=$('<ul class="s-navigation s-navigation__muted s-navigation__vertical"></ul>'),a=window.location.pathname,s=new URLSearchParams(window.location.search);return s.set("page","summary"),t.append(this.buildNavLi("Summary",`${a}?${s.toString()}`,"summary")),s.set("page","posts"),t.append(this.buildNavLi("Posts",`${a}?${s.toString()}`,"posts")),e.append(t),e}async getSummaryPageData(){if(this.pageLoadMap.summary.isLoaded&&this.pageLoadMap.summary.pageData)return this.pageLoadMap.summary.pageData;{const e=await r(`/case/summary/${this.userId}`).then((e=>e.json()));return this.pageLoadMap.summary={isLoaded:!0,pageData:e},e}}async buildCaseSummaryPage(){const e=$('<section class="flex--item fl-grow1 wmx100"><div class="s-page-title mb24"><h1 class="s-page-title--header m0 baw0 p0">Summary</h1></section>'),t=await this.getSummaryPageData(),a=$('<div class="d-grid grid__2 md:grid__1 g8"></div>');return this.systemUserRoleId<=2&&a.append(V(this.userId,t.hasOpenCase)),a.append(function(e){const t=$('<div class="grid--item p4 s-table-container"></div>'),a=$('<table class="s-table"><thead><tr><th scope="col">Post Feedback</th><th scope="col">Number of Posts</th></tr></thead></table>'),s=$("<tbody></tbody>");return e.forEach((e=>{s.append($(`<tr><td>${e.action_taken}</td><td>${e.number_of_posts}</td></tr>`))})),a.append(s),t.append(a),t}(t.postSummary)),this.systemUserRoleId<=2&&t.caseTimeline.length>0&&a.append(function(e){const t=$('<div class="grid--item p8"><h3 class="fs-title mb8">Investigation History</h3></div>'),a=$('<div class="d-flex fd-column g4"></div>');return e.forEach((e=>{a.append($(`<div class="flex--item d-flex fd-row jc-space-between ai-center" data-timeline-id="${e.case_event_id}"><a href="/users/${e.account_id}">${e.display_name}</a><span data-event-type-id="${e.case_event_type_id}">${e.case_event_description}</span><span title="${e.event_creation_date}">${D(e.event_creation_date)}</span></div>`))})),t.append(a),t}(t.caseTimeline)),e.append(a),e}cleanInitPostColumnFilters(){if(this.pageLoadMap.posts.isLoaded&&void 0!==this.pageLoadMap.posts.pageData){this.pageLoadMap.posts.pageData.header.forEach(((e,t)=>{this.postSummaryColumnFilter[t]="any"}));const e=new URLSearchParams(window.location.search);e.delete("table-filter"),window.history.replaceState({},"",`${window.location.pathname}?${e.toString()}`)}}async getBreakdownData(){if(this.pageLoadMap.posts.isLoaded&&this.pageLoadMap.posts.pageData)return this.pageLoadMap.posts.pageData;{const e=await r(`/case/posts/${this.userId}`).then((e=>e.json()));return this.pageLoadMap.posts={isLoaded:!0,pageData:e},0===Object.keys(this.postSummaryColumnFilter).length&&this.cleanInitPostColumnFilters(),e}}updateFilter(e,t){this.postSummaryColumnFilter[e]=t;const a=new URLSearchParams(window.location.search);a.set("table-filter",JSON.stringify(this.postSummaryColumnFilter)),window.history.replaceState({},"",`${window.location.pathname}?${a.toString()}`)}async buildPostsBreakdownPage(){const e=$('<section class="flex--item fl-grow1 wmx100"><div class="s-page-title mb24">\n<h1 class="s-page-title--header m0 baw0 p0">Post Status Summary</h1></section>'),t=await this.getBreakdownData(),a=$('<div class="s-table-container" style="width:min-content"></div>'),s=$('<table class="s-table"></table>');{const e=$("<thead></thead>"),a=$("<tr></tr>"),n=$("<tr></tr>");t.header.forEach(((e,t)=>{const s=`summary-post-col-filter-${t}`;{const t=$("<th></th>"),n=$(`<label for="${s}">${e}</label>`);t.append(n),a.append(t)}{const e=$("<th></th>");if(t>0){const a=$('<div class="s-select" style="width:max-content;"></div>'),n=$(`<select id="${s}">\n${N("Any","any",this.postSummaryColumnFilter[t])}\n${N("Checked","checked",this.postSummaryColumnFilter[t])}\n${N("Unchecked","unchecked",this.postSummaryColumnFilter[t])}\n</select>`);n.on("change",(e=>{e.preventDefault(),this.updateFilter(t,e.target.value),this.render()})),a.append(n),e.append(a)}else{const t=$('<button type="button" class="s-btn s-btn__sm s-btn__muted s-btn__outlined">Clear Filters</button>');t.on("click",(e=>{e.preventDefault(),this.cleanInitPostColumnFilters(),this.render()})),e.append(t)}n.append(e)}})),e.append(a),e.append(n),s.append(e)}{const e=$("<tbody></tbody>");t.body.forEach((t=>{if(t.some(((e,a)=>{const s=this.postSummaryColumnFilter[a];return"any"!==s&&("checked"===s?null===t[a]:null!==t[a])})))return;const a=$("<tr></tr>");t.forEach(((e,t)=>{0===t?a.append(`<td><a class="flex--item" href="/a/${e}" target="_blank" rel="noreferrer noopener">${e}</a></td>`):null!==e?a.append(`<td>${I()}</td>`):a.append("<td></td>")})),e.append(a)})),s.append(e)}return a.append(s),e.append(a),e}rebuildContainer(e){this.container.empty(),this.container.append(this.buildNav()),this.container.append(e)}render(){"summary"===this.currentPage?this.buildCaseSummaryPage().then((e=>{this.rebuildContainer(e)})):"posts"===this.currentPage&&this.buildPostsBreakdownPage().then((e=>{this.rebuildContainer(e)}))}}function V(e,a){const s=$('<div class="grid--item"></div>'),n=a?{containerText:"This user is <strong>currently under investigation</strong>.",buttonText:"Close current investigation",apiRoute:"close",buttonClasses:"s-btn__primary",modalOptions:{title:"Close Current Investigation",body:"Are you sure you want to close out the current investigation of this user? This will remove the user from the active cases list. Please only do this if the majority of posts have either been actioned on or if the user is not a serial plagiarist.",buttonLabel:"Yes, I'm sure"}}:{containerText:"This user is <u>not</u> currently under investigation.",buttonText:"Open an investigation",apiRoute:"open",buttonClasses:"s-btn__danger s-btn__filled",modalOptions:{title:"Open An Investigation",body:"Are you sure you want to open an investigation into this user? This will add this user to a list of users under investigation. Please only do this if you suspect the user of serial plagiarism.",buttonLabel:"Yes, I'm sure"}};s.append($('<h3 class="fs-title mb8">Case Management Console</h3>')),s.append($(`<p>${n.containerText}</p>`));const o=$(`<button class="ml16 s-btn ${n.buttonClasses}">${n.buttonText}</button>`);return o.on("click",(o=>{o.preventDefault(),StackExchange.helpers.showConfirmModal(n.modalOptions).then((o=>{o&&(a?r(`/case/${n.apiRoute}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})}):function(e,a){const s=new URLSearchParams("filter=!LnNkvqQOuAK0z-T)oydzPI");return s.set("site","stackoverflow"),s.set("key","BkvRpNB*IzKMdjAcikc4jA(("),s.set("access_token",GM_getValue(t)),fetch(`https://api.stackexchange.com/2.3${e}?${s.toString()}`)}(`/users/${e}`).then((e=>e.json())).then((e=>{if(0===e.items.length)throw Error("User not found!");const t=e.items[0];return r(`/case/${n.apiRoute}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t.user_id,displayName:t.display_name,profileImage:t.profile_image})})}))).then((t=>{if(200===t.status)return t.json().then((t=>s.replaceWith(V(e,t.hasOpenCase))));if(409===t.status)return t.json().then((t=>(StackExchange.helpers.showToast(t.message,{transientTimeout:1e4,type:"warning"}),s.replaceWith(V(e,t.hasOpenCase)))));throw Error("Something went wrong")}))}))})),s.append(o),s}const G={1:{desc:"Looks OK",colourVar:"--green-600",svg:I(16)},3:{desc:"plagiarised",colourVar:"--red-600",svg:function(e=18,t=18){return`<svg aria-hidden="true" class="svg-icon iconBriefcase" width="${e}" height="${e}" viewBox="0 0 ${t} ${t}"><path d="M5 4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v1h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7c0-1.1.9-2 2-2h1V4Zm7 0H6v1h6V4Z"></path></svg>`}(16)},5:{desc:"suspicious",colourVar:"--yellow-700",svg:C(16)}};function B(e,t){const a=$('<div class="case-manager-symbol-group d-flex fd-row g2 ba bar-sm p2" style="width:min-content"></div>');return t.forEach((e=>{if(Object.hasOwn(G,e)){const{desc:t,colourVar:s,svg:n}=G[e];a.append($(`<div title="This post is noted in the Case Manager System as ${t}" class="flex--item s-post-summary--stats-item" style="color: var(${s})">${n}</div>`))}})),a}function W(e){Object.entries(e).forEach((([e,t])=>{$(`#answer-id-${e} .s-post-summary--stats-item:eq(0)`).before(B(0,t))}))}function J(){l([...new Set($(".s-post-summary").map(((e,t)=>t.getAttribute("data-post-id"))).toArray())]).then(W)}function H(e){Object.entries(e).forEach((([e,t])=>{const a=$(`a[href$="#${e}"`);a.parent(".answer-link").addClass("d-flex fd-row ai-center g6"),a.before(B(0,t))}))}class Z{needsTotalPages;needsGroupInfo;currentPage;group;search;searchTimeout;userData;totalPages;groupInfo;constructor(){this.needsTotalPages=!0,this.needsGroupInfo=!0,this.currentPage=1,this.totalPages=1,this.group="1",this.userData=[],this.search="",this.groupInfo=[]}setCurrentPage(){const e=new URLSearchParams(window.location.search);e.has("page")&&(this.currentPage=Number(e.get("page"))),e.has("group")&&(this.group=e.get("group")),e.has("search")&&(this.search=e.get("search"))}buildUsersURLWithParams(e){const t=new URLSearchParams("?tab=case");return t.set("group",this.group),t.set("page",(void 0===e?this.currentPage:e).toString()),this.search.length>0&&t.set("search",this.search),`/users?${t.toString()}`}pullDownData(){const e=new URLSearchParams;return e.set("group",this.group),e.set("page",this.currentPage.toString()),this.search.length>0&&e.set("search",this.search),this.needsTotalPages&&e.set("total-pages","true"),this.needsGroupInfo&&e.set("group-info","true"),r(`/cases?${e.toString()}`).then((e=>e.json())).then((e=>{this.totalPages=e.totalPages||this.totalPages,this.groupInfo=e.groupInfo||this.groupInfo,this.userData=e.cases}))}pullDownAndRender(){return this.pullDownData().then((()=>{this.render()}))}init(){this.setCurrentPage();const e=$('<input id="userfilter" name="userfilter" class="s-input s-input__search h100 wmx3" autocomplete="off" type="text" placeholder="Filter by user">');this.search.length>0&&e.val(this.search),e.on("input",(e=>{clearTimeout(this.searchTimeout),this.search!==e.target.value&&(this.search=e.target.value,this.searchTimeout=setTimeout((()=>{this.currentPage=1,this.needsTotalPages=!0,window.history.pushState("search_paging","",this.buildUsersURLWithParams()),this.pullDownAndRender()}),450))})),$("#mainbar-full").empty().append($('<h1 class="fs-headline1 mb24">Plagiarists</h1>')).append($('<div class="d-flex fw-wrap ai-stretch md:d-block"></div>').append($('<div class="flex--item mb12 ps-relative"></div>').append(e).append($(function(e=18,t=18){return`<svg aria-hidden="true" class="s-input-icon s-input-icon__search svg-icon iconSearch" width="${e}" height="${e}" viewBox="0 0 ${t} ${t}"><path d="m18 16.5-5.14-5.18h-.35a7 7 0 1 0-1.19 1.19v.35L16.5 18l1.5-1.5ZM12 7A5 5 0 1 1 2 7a5 5 0 0 1 10 0Z"></path></svg>`}()))).append($('<div class="flex--item ml-auto mb12 h100 d-flex s-btn-group js-filter-btn">\n<a class="js-sort-preference-change flex--item s-btn s-btn__muted s-btn__outlined" href="/users?tab=reputation"\ndata-nav-xhref="" title="Users with the highest reputation scores" data-value="reputation" data-shortcut=""\naria-current="page"> Reputation</a>\n<a class="js-sort-preference-change flex--item s-btn s-btn__muted s-btn__outlined" href="/users?tab=newusers"\ndata-nav-xhref="" title="Users who joined in the last 30 days" data-value="newusers" data-shortcut=""> New\nusers</a>\n<a class="js-sort-preference-change flex--item s-btn s-btn__muted s-btn__outlined" href="/users?tab=voters"\ndata-nav-xhref="" title="Users who voted more than 10 times" data-value="voters" data-shortcut=""> Voters</a>\n<a class="js-sort-preference-change flex--item s-btn s-btn__muted s-btn__outlined" href="/users?tab=editors"\ndata-nav-xhref="" title="Users who edited at least 5 posts" data-value="editors" data-shortcut=""> Editors</a>\n<a class="js-sort-preference-change flex--item s-btn s-btn__muted s-btn__outlined" href="/users?tab=moderators"\ndata-nav-xhref="" title="Our current community moderators" data-value="moderators" data-shortcut="">\nModerators</a>\n<a class="js-sort-preference-change youarehere is-selected flex--item s-btn s-btn__muted s-btn__outlined" href="/users?tab=case"\ndata-nav-xhref="" title="Users who have been or are currently under investigation" data-value="plagiarist"\ndata-shortcut="">Plagiarists</a>\n</div>'))).append($('<div class="fs-body2 mt8 mb12"><div class="d-flex jc-space-between"><div class="flex--item ml-auto md:ml0"><div id="tabs-interval" class="subtabs d-flex"></div></div></div></div>')).append($('<div id="user-browser" class="d-grid grid__4 lg:grid__3 md:grid__2 sm:grid__1 g12"></div>')).append($('<div id="user-pagination" class="s-pagination site1 themed pager float-right"></div>')),this.pullDownData().then((()=>{this.needsTotalPages=!1,this.needsGroupInfo=!1,this.render()})),window.addEventListener("popstate",(()=>{this.setCurrentPage(),this.pullDownAndRender()}))}buildGroupToggleLink(e,t){const a=new URLSearchParams("?tab=case");a.set("group",e),this.search.length>0&&a.set("search",this.search);const s=`/users?${a.toString()}`,n=$(`<a${e===this.group?' class="youarehere is-selected"':""} href="${s}" data-nav-xhref="" data-value="${e}" data-shortcut="">${t}</a>`);return n.on("click",(t=>{t.preventDefault(),this.group!==e&&(window.history.pushState("group_paging","",s),this.group=e,this.currentPage=1,this.needsTotalPages=!0,this.pullDownAndRender())})),n}buildGroupToggle(){const e=$("#tabs-interval").empty();this.groupInfo.forEach((t=>{e.append(this.buildGroupToggleLink(t.group_id,t.description))}))}buildUserPanel(){const e=$("#user-browser").empty();this.userData.forEach((t=>{e.append(function(e,t,a,s,n,o){const i=`/users/${e}?tab=case-manager`;return $(`<div class="grid--item user-info">\n${null!==t?`<div class="user-gravatar48">\n<a href="${i}"><div class="gravatar-wrapper-48"><img src="${t}" alt="${a}'s user avatar" width="48" height="48" class="bar-sm"></div></a>\n</div>`:""}\n<div class="user-details">\n<a href="${i}">${a}</a>\n<div class="-flair">\n<span title="the number of posts marked as plagiairsm for this user" dir="ltr">${s} Plagiarised posts</span>\n</div>\n<div class="d-flex fd-column mt6">\n<span>Case ${n} on</span>\n<span title="${o}">${D(o)}</span>\n</div>\n</div>\n</div>`)}(t.investigated_user_id,t.profile_image,t.display_name,t.number_of_plagiarised_posts,t.current_state,t.event_creation_date))}))}buildNavItem(e,t){void 0===t&&(t=e);const a=this.buildUsersURLWithParams(e),s=$(`<a class="s-pagination--item" href="${a}">${t}</a>`);return s.on("click",(t=>{t.preventDefault(),window.history.pushState("paging","",a),this.currentPage=e,this.pullDownAndRender()})),s}buildPagination(){const e=$("#user-pagination").empty();if(1===this.totalPages)return;const t=t=>{const a=t+1;a===this.currentPage?e.append(`<span class="s-pagination--item is-selected" aria-current="page">${a}</span>`):e.append(this.buildNavItem(a))};1!==this.currentPage&&e.append(this.buildNavItem(this.currentPage-1,"Prev")),this.totalPages<=7?[...Array(this.totalPages).keys()].forEach(t):(this.currentPage-5>=0&&(e.append(this.buildNavItem(1)),e.append('<span class="s-pagination--item s-pagination--item__clear">…</span>')),this.currentPage<5?[...Array(5).keys()].forEach(t):this.currentPage>this.totalPages-5?[...Array(5).keys()].forEach((e=>{t(this.totalPages-5+e)})):[...Array(5).keys()].forEach((e=>{t(this.currentPage-Math.ceil(2.5)+e)})),this.totalPages-this.currentPage>=5&&(e.append('<span class="s-pagination--item s-pagination--item__clear">…</span>'),e.append(this.buildNavItem(this.totalPages)))),this.currentPage!==this.totalPages&&e.append(this.buildNavItem(this.currentPage+1,"Next"))}render(){this.buildGroupToggle(),this.buildUserPanel(),this.buildPagination()}}StackExchange.ready((()=>{null!==GM_getValue(e,null)?null!==window.location.pathname.match(/^\/questions\/.*/)?function(){if(GM_getValue(a)>3)return;const e=$("div.answer"),t=e.map(((e,t)=>Number($(t).attr("data-answerid")))).toArray(),o=!0===StackExchange.options.user.isModerator;for(const{jAnswer:a,isDeleted:s,answerId:n,postOwnerId:i}of function*(e,t){for(let a=0;a<e.length;a++){const s=$(e[a]),n=s.hasClass("deleted-answer"),o=t[a],i=A(s.find('div[itemprop="author"]'));void 0!==o&&i!==StackExchange.options.user.userId&&(yield{jAnswer:s,isDeleted:n,answerId:o,postOwnerId:i})}}(e,t)){const e=$('<div class="p8 g8 d-flex fd-row jc-space-between ai-center"></div>');e.append(L(n)),e.append(w(o,s,n,i)),e.append(E(n,i,s)),a.append(e)}o?Stacks.addController("socm-handle-post-form",{targets:["submit-button","flag-enable-toggle","comment-enable-toggle","log-enable-toggle","flag-info-area","comment-info-area","flag-original-source-area","flag-detail-area","comment-area"],get shouldFlag(){return this["flag-enable-toggleTarget"].checked},get shouldComment(){return this["comment-enable-toggleTarget"].checked},get shouldLog(){return this["log-enable-toggleTarget"].checked},get commentText(){return this["comment-areaTarget"].value??""},get flagOriginalSourceText(){return this["flag-original-source-areaTarget"].value??""},get flagDetailText(){return this["flag-detail-areaTarget"].value??""},connect(){const e=JSON.parse(GM_getValue(n,s));this["flag-enable-toggleTarget"].checked=e.flag,this["comment-enable-toggleTarget"].checked=e.comment,this["log-enable-toggleTarget"].checked=e.log,e.flag||$(this["flag-info-areaTarget"]).addClass("d-none"),e.comment||$(this["comment-info-areaTarget"]).addClass("d-none"),this["flag-detail-areaTarget"].value=e.flagDetailText??"",this["comment-areaTarget"].value=e.commentText??""},async handleNukeSubmitActions(e){await y(e,$(this["submit-buttonTarget"]),(async(e,t)=>{await _(t,e,this.flagOriginalSourceText,this.flagDetailText,this.commentText,this.shouldFlag,!0,this.shouldComment,this.shouldLog),window.location.reload()}))},cancelHandleForm(e){e.preventDefault();const{postId:t}=e.params;p(v(t))},handleUpdateControlledField(e){const{controls:t}=e.params;e.target.checked?$(this[`${t}Target`]).removeClass("d-none"):$(this[`${t}Target`]).addClass("d-none")}}):Stacks.addController("socm-handle-post-form",{targets:["flag-original-source-area","flag-detail-area","log-enable-toggle","submit-button"],get shouldLog(){return this["log-enable-toggleTarget"].checked},get flagOriginalSourceText(){return this["flag-original-source-areaTarget"].value??""},get flagDetailText(){return this["flag-detail-areaTarget"].value??""},connect(){this["log-enable-toggleTarget"].checked=!0},async handleFlagSubmitActions(e){await y(e,$(this["submit-buttonTarget"]),(async(e,t)=>{const a=await _(t,e,this.flagOriginalSourceText,this.flagDetailText,"",!0,!1,!1,this.shouldLog);p(v(t)),void 0!==a&&StackExchange.helpers.showToast(a)}))},cancelHandleForm(e){e.preventDefault();const{postId:t}=e.params;p(v(t))}}),function(){const e=new RegExp(`\\[(.*?)]\\((?:${window.location.origin})/([^)]+)\\)`,"g"),t=[t=>t.replace(e,"[$1](/$2)"),e=>e.replace(/\[(.*?)]\(\/questions\/(\d+)\/[^/#]+(?:\?.+?)?\)/g,"[$1](/q/$2)"),e=>e.replace(/\[(.*?)]\(\/questions\/\d+\/.+?#(\d+)(?:\?.+?)?\)/g,"[$1](/a/$2)"),e=>e.replace(/\[(.*?)]\(\/questions\/\d+\/.+?#comment(\d+)_\d+\)/g,"[$1](/posts/comments/$2)"),e=>e.replace(/\[(.*?)]\(\/users\/(\d+)\/[^?]+(\?tab=.+?)?\)/g,((e,t,a,s)=>void 0===s||"?tab=profile"===s?`[${t}](/users/${a})`:`[${t}](/users/${a}${s})`))];Stacks.addController("socm-absolute-link-reducer",{handleReduceText(e){const a=e.target,[s,n]=(o=t,i=a.value,r=a.selectionStart,o.reduce((([e,t],a)=>{const s=e.length;return[e=a(e),t=Math.max(0,t-(s-e.length))]}),[i,r]));var o,i,r;a.value=s,a.selectionStart=n,a.selectionEnd=n}})}(),function(e){var t;(t=e,t.length<=0?Promise.resolve(new Set):r(`/summary/posts/${t.join(";")}`).then((e=>e.json())).then((e=>Promise.resolve(new Set(e))))).then((e=>{for(const t of e)j(t)})).catch((e=>{console.error(e)}))}(t)}():null!==window.location.pathname.match(/^\/users$/)?GM_getValue(a)>2||($(".js-filter-btn").append($('<a class="js-sort-preference-change flex--item s-btn s-btn__muted s-btn__outlined" href="/users?tab=case" data-nav-xhref="" title="Users who have been or are currently under investigation" data-value="plagiarist" data-shortcut="">Plagiarists</a>')),window.location.search.startsWith("?tab=case")&&(new Z).init()):null!==window.location.pathname.match(new RegExp(`^/users/(account-info/)?${StackExchange.options.user.userId}.*`))?($(".user-show-new .s-navigation:eq(0)").append($('<a href="/users/current?tab=case-manager-settings" class="s-navigation--item">Case Manager Settings</a>')),window.location.search.startsWith("?tab=case-manager-settings")&&$("#mainbar-full").empty().append(function(){const o=$('<div class="s-page-title mb24"><h1 class="s-page-title--header m0 baw0 p0">Case Manager UserScript Settings</h1></div>'),i=$('<div class="d-grid grid__2 md:grid__1 g32"></div>');return i.append($("<div></div>").append('<h3 class="fs-title mb12">Existing Auth Tokens</h3>').append(function(){const a=$('<div><div class="is-loading">Loading...</div></div>');return r("/auth/credentials").then((e=>e.json())).then((s=>{a.empty(),s.forEach((s=>{a.append(function(a){const s=$('<div class="d-flex fd-row ai-center"></div>'),n=$('<button class="s-btn s-btn__danger">Invalidate</button>');return n.on("click",(n=>{n.preventDefault(),r(`/auth/credentials/${a}/invalidate`).then((n=>{200===n.status&&(s.remove(),GM_getValue(t)===a&&(GM_deleteValue(t),GM_deleteValue(e),window.location.reload()))}))})),s.append(`<span>${a}</span>`).append(n)}(s))}))})),a}()).append(function(){const a=$('<button class="s-btn s-btn__outlined s-btn__danger mt16" id="app-24380">De-authenticate Application</button>');return a.on("click",(a=>{a.preventDefault(),StackExchange.helpers.showConfirmModal({title:"De-authenticate this Application",bodyHtml:"<p>Are you sure you want to de-authenticate this application? All existing access tokens will be invalidated and removed from storage. This app will no longer appear in your authorized applications list. You will no longer be able to use any existing access tokens and will need to reauthenticate to continue use.</p><p><b>Note:</b> All of your actions will be retained and associated to your user id even after de-authenticating. You may resume access at any time by authorising the application again.</p>",buttonLabel:"De-authenticate"}).then((a=>{a&&r(`/auth/credentials/${GM_getValue(t)}/de-authenticate`).then((a=>{200===a.status&&(GM_deleteValue(t),GM_deleteValue(e),window.location.reload())}))}))})),a}())),i.append($("<div></div>").append('<h3 class="fs-title mb12">Issue new token</h3>').append("<p>You can issue a new auth token for use on another device or to manually replace an existing token. Please invalidate any existing tokens, so they can no longer be used to access your information.</p>").append(`<a class="s-link s-link__underlined" href="${d}" target="_blank" rel="noopener noreferrer">Issue new auth token</a>`)),GM_getValue(a)<=3&&StackExchange.options.user.isModerator&&i.append((Stacks.addController("socm-nuke-config-settings",{targets:["nuke-config-should-flag","nuke-config-should-comment","nuke-config-should-log","nuke-config-flag-template","nuke-config-comment-template"],get shouldFlag(){return this["nuke-config-should-flagTarget"].checked},get shouldComment(){return this["nuke-config-should-commentTarget"].checked},get shouldLog(){return this["nuke-config-should-logTarget"].checked},get commentTemplate(){return this["nuke-config-comment-templateTarget"].value??""},get flagTemplate(){return this["nuke-config-flag-templateTarget"].value??""},setValues(e){this["nuke-config-should-flagTarget"].checked=e.flag,this["nuke-config-should-commentTarget"].checked=e.comment,this["nuke-config-should-logTarget"].checked=e.log,this["nuke-config-flag-templateTarget"].value=e.flagDetailText??"",this["nuke-config-comment-templateTarget"].value=e.commentText??""},connect(){const e=JSON.parse(GM_getValue(n,s));this.setValues(e)},handleSaveConfig(e){e.preventDefault();try{const e={flagDetailText:this.flagTemplate,commentText:this.commentTemplate,flag:this.shouldFlag,comment:this.shouldComment,log:this.shouldLog};GM_setValue(n,JSON.stringify(e)),StackExchange.helpers.showToast("Config updated successfully!",{type:"success",transientTimeout:3e3})}catch(t){StackExchange.helpers.showToast(b(t),{type:"danger",transientTimeout:5e3})}},handleResetConfig(e){e.preventDefault();const t=JSON.parse(s);this.setValues(t)}}),$("<div></div>").append('<h3 class="fs-title mb12">Edit base options for nuking posts</h3>').append('<form class="d-flex fd-column g12" data-controller="socm-nuke-config-settings" data-action="submit->socm-nuke-config-settings#handleSaveConfig reset->socm-nuke-config-settings#handleResetConfig"><div class="s-check-control"><input class="s-checkbox" type="checkbox" id="socm-nuke-config-should-flag" data-socm-nuke-config-settings-target="nuke-config-should-flag" /><label class="s-label" for="socm-nuke-config-should-flag">Should Flag</label></div><div class="s-check-control"><input class="s-checkbox" type="checkbox" id="socm-nuke-config-should-comment" data-socm-nuke-config-settings-target="nuke-config-should-comment" /><label class="s-label" for="socm-nuke-config-should-comment">Should Comment</label></div><div class="s-check-control"><input class="s-checkbox" type="checkbox" id="socm-nuke-config-should-log" data-socm-nuke-config-settings-target="nuke-config-should-log" /><label class="s-label" for="socm-nuke-config-should-log">Should Log</label></div><div class="d-flex ff-column-nowrap gs4 gsy" data-controller="se-char-counter" data-se-char-counter-min="10" data-se-char-counter-max="500"><label class="s-label flex--item" for="socm-nuke-config-flag-template">Flag Detail Text Template:</label><textarea class="flex--item s-textarea" data-se-char-counter-target="field" data-is-valid-length="false" id="socm-nuke-config-flag-template" name="flag detail template" rows="5" data-socm-nuke-config-settings-target="nuke-config-flag-template" data-action="socm-absolute-link-reducer#handleReduceText"></textarea><div data-se-char-counter-target="output"></div></div><div class="d-flex ff-column-nowrap gs4 gsy" data-controller="se-char-counter" data-se-char-counter-min="15" data-se-char-counter-max="600"><label class="s-label flex--item" for="socm-nuke-config-comment-template">Comment Text Template:</label><textarea class="flex--item s-textarea" data-se-char-counter-target="field" data-is-valid-length="false" id="socm-nuke-config-comment-template" name="comment template" rows="5" data-socm-nuke-config-settings-target="nuke-config-comment-template" data-action="socm-absolute-link-reducer#handleReduceText"></textarea><div data-se-char-counter-target="output"></div></div><div class="d-flex fd-row g8"><button class="s-btn s-btn__primary" type="submit">Save Config</button><button class="s-btn s-btn__muted" type="reset">Reset To Default</button></div></form>'))),i.append($("<div></div>").append('<h3 class="fs-title mb12">Your Privilege Info</h3>').append(function(){const e=$('<div><div class="is-loading">Loading...</div></div>');return r("/auth/credentials/my-role/details").then((e=>e.json())).then((({role_id:t,role_description:s})=>{e.empty(),GM_setValue(a,t),e.append(`<div><span>You are currently have <span class="td-underline">${s}</span> level privileges.</span></div>`)})),e}())),$(document.createDocumentFragment()).append(o).append(i)}())):null!==window.location.pathname.match(/^\/users\/.*/)&&function(){if(GM_getValue(a)>3)return;if(null!==window.location.pathname.match(/^\/users\/flagged-posts\/.*/)||null!==window.location.pathname.match(/^\/users\/flag-summary\/.*/))return void l([...new Set($(".flagged-post .answer-link a").map(((e,t)=>{const a=t.getAttribute("href");if(null!==a&&a.includes("#"))return a.split("#").at(-1)})).toArray())]).then(H);const e=function(){const e=window.location.pathname.match(/^\/users\/(account-info\/)?\d+/g);if(null===e||1!==e.length)throw Error("Something changed in user path!");return Number(e[0].split("/").at(-1))}(),{tabContainer:t,navButton:s}=function(e){const t=$(`<a href="/users/${e}/?tab=case-manager" class="s-navigation--item">Case Manager</a>`);r(`/case/user/${e}`).then((e=>e.json())).then((e=>{e.is_known_user&&t.prepend(C(16,20))}));const a=$(".user-show-new .s-navigation:eq(0)");return a.append(t),{tabContainer:a,navButton:t}}(e);window.location.search.startsWith("?tab=case-manager")?(function(e,t){const a="is-selected";e.find("a").removeClass(a),t.addClass(a)}(t,s),function(e){$("#mainbar-full > div:last-child").replaceWith(new U(e).init())}(e)):window.location.search.startsWith("?tab=answers")&&function(){J();const e=new RegExp("users/tab/\\d+\\?tab=answers","gi");$(document).on("ajaxComplete",((t,a,{url:s})=>{s.match(e)&&J()}))}()}():function(){const e="case-manager-client-auth-modal";$("body").append($(`<aside class="s-modal" id="${e}" role="dialog" aria-labelledby="${e}-modal-title" aria-describedby="${e}-modal-description" aria-hidden="false" data-controller="s-modal" data-s-modal-target="modal"></aside>`).append(function(e){return $('<div class="s-modal--dialog" role="document"></div>').append($(`<h1 class="s-modal--header" id="${e}-modal-title">Authorise Case Manager</h1>`)).append($(`<p class="s-modal--body" id="${e}-modal-description">The Case Manager requires API access validate your user account.</p>`)).append(function(e){return $("<ol></ol>").append(`<li><a class="s-link s-link__underlined" href="${d}" target="_blank" rel="noopener noreferrer">Authorise App</a></li>`).append(`<li><label for="${c(e)}" class="mr6">Access Token:</label><input style="width:225px" id="${c(e)}"/></li>`)}(e)).append(function(e){const a=$(`<button class="flex--item s-btn s-btn__primary" type="button" id="${e}-save">Save</button>`);return a.on("click",(a=>{a.preventDefault();const s=$(`#${c(e)}`).val();void 0!==s&&s.length>0&&(GM_setValue(t,s),o().then((()=>{window.location.reload()})))})),$('<div class="d-flex g8 gsx s-modal--footer"></div>').append(a).append('<button class="flex--item s-btn" type="button" data-action="s-modal#hide">Cancel</button>')}(e)).append('<button class="s-modal--close s-btn s-btn__muted" aria-label="Close" data-action="s-modal#hide"><svg aria-hidden="true" class="svg-icon iconClearSm" width="14" height="14" viewBox="0 0 14 14"><path d="M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41Z"></path></svg></button>')}(e)))}()}))}();
